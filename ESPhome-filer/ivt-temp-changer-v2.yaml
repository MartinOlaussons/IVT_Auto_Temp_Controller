esphome:
  name: ivt-temp-controller
  friendly_name: IVT Temp C

esp8266:
  board: d1_mini

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "2+wvDiHuDVqm4e49Xumm2BRZRQr7JCrO/5T4ENsQLRk="

ota:
  - platform: esphome
    password: "9c5126b852b2be8de2f821782907f22c"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Ivt-Temp-Controller"
    password: "qiU68Sjoziep"

captive_portal:
    
spi:
  clk_pin: GPIO14
  mosi_pin: GPIO13

# declaration of external component
external_components:
  - source: 
      type: git
      url: http://github.com/MartinOlaussons/MCP41010-ESPHome

# MCP41010
mcp41010:
  id: my_pot
  cs_pin: GPIO15

# Relä till IVT utetemp-ingång
switch:
  - platform: gpio
    pin: D1
    name: "IVT Temp Tweaker Relay"
    restore_mode: ALWAYS_OFF

# Slider i Home Assistant som styr MCP41010 via lambda
number:
  - platform: template
    name: "IVT DigiPot"
    id: digipot_level
    optimistic: true
    min_value: -40
    max_value: 40
    initial_value: 20
    step: 0.5
    mode: slider
    on_value:
      then:
        - lambda: |-
            float T_C = id(digipot_level).state;
            int digipot_val = int(0.0001652*T_C*T_C*T_C + 0.009451*T_C*T_C + 0.7373*T_C + 40.98);
            id(my_pot).set_value(digipot_val);

# Test: button to define a value
button:

  - platform: template
    name: "PLUS"
    id: digipot_plus
    on_press:
      - logger.log: Button PLUS Pressed
      - number.increment: digipot_level

  - platform: template
    name: "MINUS"
    id: digipot_minus
    on_press:
      - logger.log: Button MINUS Pressed
      - number.decrement: digipot_level
